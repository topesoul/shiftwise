<!-- /workspace/shiftwise/templates/base.html -->

{% load crispy_forms_tags %}
{% load static %}
{% load custom_filters %}
{% load custom_tags %}

<!DOCTYPE html>
<html lang="en" data-theme="light" data-user-id="{% if user.is_authenticated %}{{ user.id }}{% else %}0{% endif %}">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Site metadata -->
    <title>{% block title %}ShiftWise App{% endblock %}</title>
    <meta name="description" content="ShiftWise App - Efficiently manage your shifts and schedules.">
    <meta name="keywords" content="ShiftWise, shift management, schedule, productivity">
    
    <!-- API configuration -->
    <meta name="google-maps-api-key" content="{{ GOOGLE_PLACES_API_KEY }}">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/apple-touch-icon.png' %}">

    <!-- External dependencies -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- App stylesheets -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/components.css' %}">
    <link rel="stylesheet" href="{% static 'css/why_shiftwise.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/subscription.css' %}">
    <link rel="stylesheet" href="{% static 'css/report_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/table.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">

    {% block extra_css %}{% endblock %}
    
    <style>
    .pac-container {
        z-index: 10000 !important;
    }

    .address-autocomplete {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 35px !important;
    }

    .modal, .modal-dialog, .modal-content, .modal-body {
        overflow: visible !important;
    }
    </style>
</head>

<body class="d-flex flex-column min-vh-100">
    {% include 'includes/navbar.html' %}

    <main class="container my-4" role="main">
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" aria-live="polite">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" aria-pressed="false">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    <footer class="footer text-center py-3 mt-auto" role="contentinfo">
        <p>&copy; {% now "Y" %} ShiftWise App</p>
        <p>Developed by <a href="https://linkedin.com/in/topeakingbala" target="_blank"
                rel="noopener noreferrer">Temitope Akingbala</a></p>
    </footer>

    <!-- Core dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="{% static 'js/dark_mode_toggle.js' %}" defer></script>
    
    {% block extra_js %}{% endblock %}

    <script>
    // Track initialization state
    window.googleMapsInitialized = false;

    function initializeAutocomplete() {
        if (!window.google || !window.google.maps || !window.google.maps.places) return;
        if (window.googleMapsInitialized) return;
        
        window.googleMapsInitialized = true;
        
        function setupAutocomplete(field) {
            if (field._hasAutocomplete) return;
            
            try {
                const autocomplete = new google.maps.places.Autocomplete(field, {
                    types: ['address'],
                    componentRestrictions: { country: ['gb'] },
                    fields: ['address_components', 'geometry', 'formatted_address']
                });
                
                field._hasAutocomplete = true;
                
                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) return;
                    
                    const form = field.closest('form');
                    if (!form) return;
                    
                    const fields = {
                        address1: form.querySelector('#id_address_line1'),
                        address2: form.querySelector('#id_address_line2'),
                        city: form.querySelector('#id_city'),
                        county: form.querySelector('#id_county'),
                        postcode: form.querySelector('#id_postcode'),
                        country: form.querySelector('#id_country'),
                        latitude: form.querySelector('#id_latitude'),
                        longitude: form.querySelector('#id_longitude')
                    };
                    
                    // Clear fields
                    if (fields.address2) fields.address2.value = '';
                    if (fields.city) fields.city.value = '';
                    if (fields.county) fields.county.value = '';
                    if (fields.postcode) fields.postcode.value = '';
                    if (fields.country) fields.country.value = 'United Kingdom';
                    
                    // Extract address components
                    let streetNumber = '';
                    let route = '';
                    
                    place.address_components.forEach(function(component) {
                        const types = component.types;
                        
                        if (types.includes('street_number')) {
                            streetNumber = component.long_name;
                        } 
                        else if (types.includes('route')) {
                            route = component.long_name;
                        }
                        else if ((types.includes('locality') || types.includes('postal_town')) && fields.city && !fields.city.value) {
                            fields.city.value = component.long_name;
                        }
                        else if (types.includes('administrative_area_level_2') && fields.county) {
                            fields.county.value = component.long_name;
                        }
                        else if (types.includes('postal_code') && fields.postcode) {
                            fields.postcode.value = component.long_name;
                        }
                        else if (types.includes('country') && fields.country) {
                            fields.country.value = component.long_name;
                        }
                    });
                    
                    // Set address line 1
                    if (fields.address1) {
                        if (streetNumber && route) {
                            fields.address1.value = streetNumber + ' ' + route;
                        } else if (route) {
                            fields.address1.value = route;
                        }
                    }
                    
                    // Set coordinates
                    if (fields.latitude && place.geometry && place.geometry.location) {
                        fields.latitude.value = place.geometry.location.lat();
                    }
                    if (fields.longitude && place.geometry && place.geometry.location) {
                        fields.longitude.value = place.geometry.location.lng();
                    }
                });
            } catch (error) {
                console.error("Error setting up autocomplete:", error);
            }
        }
        
        // Initialize existing address fields
        document.querySelectorAll('.address-autocomplete').forEach(setupAutocomplete);
        
        // Handle dynamically loaded fields in modals
        if (typeof jQuery !== 'undefined') {
            jQuery(document).on('shown.bs.modal', function(e) {
                const modal = e.target;
                const addressFields = modal.querySelectorAll('.address-autocomplete');
                if (addressFields.length > 0) {
                    addressFields.forEach(setupAutocomplete);
                }
            });
        }
    }

    function googleMapsCallback() {
        initializeAutocomplete();
        window.initializeAutocomplete = initializeAutocomplete;
    }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&libraries=places&loading=async&callback=googleMapsCallback"></script>
</body>

</html>
